<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::main})}">

<head>
    <title>Formulaire Pro-forma</title>
</head>

<body>
    <main>
        <div class="container">
            <h1>üìã Pro-forma</h1>

            <div th:if="${proforma?.id}">
                <h2>Modification Pro-forma <span th:text="${proforma.numero}">PF001</span></h2>
            </div>
            <div th:unless="${proforma?.id}">
                <h2>Nouvelle Pro-forma depuis DA</h2>
            </div>

            <div class="card">
                <h3>Demande d'Achat</h3>
                <dl>
                    <dt>N¬∞ DA:</dt>
                    <dd th:text="${proforma.demandeAchat?.numero}">DA001</dd>

                    <dt>Service:</dt>
                    <dd th:text="${proforma.demandeAchat?.service?.libelle}">-</dd>

                    <dt>Montant estim√© HT:</dt>
                    <dd th:text="${#numbers.formatDecimal(proforma.demandeAchat?.montantEstimeHt, 1, 2, 'COMMA')}">-
                    </dd>

                    <dt>Date besoin:</dt>
                    <dd th:text="${#temporals.format(proforma.demandeAchat?.dateBesoin, 'dd/MM/yyyy')}">-</dd>
                </dl>
            </div>

            <form th:action="${proforma?.id} ? @{/achats/pro-formas/{id}(id=${proforma.id})} : @{/achats/pro-formas}"
                th:method="post" th:object="${proforma}" id="proforma-form">

                <input type="hidden" th:field="*{demandeAchat.id}" />
                <input type="hidden" th:field="*{numero}" />
                <input type="hidden" th:field="*{statut}" />
                <input type="hidden" th:field="*{dateCreation}" />
                <input type="hidden" th:field="*{createur.id}" />
                <input type="hidden" id="lignes-modifiees" name="lignesModifiees" value="" />

                <!-- Lignes de la Pro-forma -->
                <div class="form-group">
                    <h3>üì¶ Articles Pro-forma</h3>
                    <table style="margin-top: 1rem; width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Article</th>
                                <th style="width: 12%;">Quantit√©</th>
                                <th style="width: 15%;">Prix Unitaire HT</th>
                                <th style="width: 12%;">Remise %</th>
                                <th style="width: 18%;">Total HT</th>
                                <th style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="lignes-proforma-body">
                            <!-- Les lignes seront ajout√©es depuis la DA -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold;">Total HT:</td>
                                <td id="total-ligne-ht" style="font-weight: bold;">0.00 ‚Ç¨</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="form-group">
                    <label>Fournisseur:</label>
                    <select th:field="*{fournisseur}" required>
                        <option value="">-- S√©lectionner --</option>
                        <option th:each="f : ${fournisseurs}" th:value="${f.id}" th:text="${f.raisonSociale}">
                            Fournisseur
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Montant Total HT:</label>
                    <input type="number" th:field="*{montantTotalHt}" step="0.01" required />
                </div>

                <div class="form-group">
                    <label>Montant TVA (20%):</label>
                    <input type="number" th:field="*{montantTva}" step="0.01" readonly />
                </div>

                <div class="form-group">
                    <label>Montant Total TTC:</label>
                    <input type="number" th:field="*{montantTotalTtc}" step="0.01" readonly />
                </div>

                <div class="form-group">
                    <label>D√©lai de livraison (jours):</label>
                    <input type="number" th:field="*{delaiLivraisonJours}" required />
                </div>

                <div class="form-group">
                    <label>Date de validit√©:</label>
                    <input type="date" th:field="*{dateValidite}" required />
                </div>

                <div class="form-group">
                    <label>Conditions commerciales:</label>
                    <textarea th:field="*{conditionsCommerciales}" rows="4"
                        placeholder="Saisir les conditions..."></textarea>
                </div>

                <div class="form-group">
                    <label>Remarques:</label>
                    <textarea th:field="*{remarques}" rows="3" placeholder="Notes suppl√©mentaires..."></textarea>
                </div>

                <div class="actions">
                    <button type="submit" class="btn btn-primary" onclick="sauvegarderLignes(event)">üíæ Enregistrer</button>
                    <a th:href="${proforma?.id} ? @{/achats/pro-formas/{id}(id=${proforma.id})} : @{/achats/pro-formas}"
                        class="btn">Annuler</a>
                </div>
            </form>

            <!-- Donn√©es des lignes PF stock√©es dans un attribut data -->
            <div id="lignes-pf-data" style="display:none;" th:attr="data-lignes=${lignesPFJson}"></div>

        </div>

        <script th:inline="javascript">
            (function () {
                'use strict';

                console.log('üîÑ Script IIFE d√©marr√©');

                // R√©cup√©rer l'ID de la proforma du formulaire
                const proformaId = /*[[${proforma.id}]]*/ null;
                console.log('üìù ProformaId:', proformaId);

                // Initialiser les lignes vides au d√©marrage
                let lignesProformaData = [];

                document.addEventListener('DOMContentLoaded', function () {
                    console.log('üîÑ DOMContentLoaded - Initialisation du formulaire Pro-forma');

                    // Si c'est une modification (proforma.id exists), charger les lignes via fetch
                    if (proformaId) {
                        console.log('üì° Chargement des lignes via fetch...');
                        fetch('/achats/pro-formas/api/' + proformaId + '/lignes')
                            .then(response => {
                                console.log('‚úÖ R√©ponse re√ßue:', response.status);
                                if (!response.ok) {
                                    throw new Error('Erreur ' + response.status);
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('‚úÖ Lignes charg√©es:', data);
                                lignesProformaData = data;
                                afficherLignes();
                            })
                            .catch(error => {
                                console.error('‚ùå Erreur fetch:', error);
                            });
                    } else {
                        console.log('‚ûï Nouvelle pro-forma - aucune ligne √† charger');
                        afficherLignes();
                    }

                    function afficherLignes() {
                        console.log('üì¶ Affichage des lignes:', lignesProformaData.length);

                        // Ajouter les lignes
                        const tbody = document.getElementById('lignes-proforma-body');
                        if (tbody && lignesProformaData.length > 0) {
                            lignesProformaData.forEach(function (ligne, index) {
                                ajouterLigneProforma(ligne, index);
                            });
                        } else {
                            console.warn('‚ö†Ô∏è Aucune ligne √† afficher');
                        }
                    }

                    // Event listener sur le champ montantTotalHt
                    const montantHtInput = document.querySelector('input[name="montantTotalHt"]');
                    const montantTvaInput = document.querySelector('input[name="montantTva"]');
                    const montantTtcInput = document.querySelector('input[name="montantTotalTtc"]');

                    function calculateTotals() {
                        const ht = parseFloat(montantHtInput.value) || 0;
                        const tva = ht * 0.20;
                        const ttc = ht + tva;

                        montantTvaInput.value = tva.toFixed(2);
                        montantTtcInput.value = ttc.toFixed(2);
                    }

                    if (montantHtInput) {
                        montantHtInput.addEventListener('change', calculateTotals);
                        montantHtInput.addEventListener('input', calculateTotals);
                        calculateTotals();
                    }

                    function ajouterLigneProforma(ligne, index) {
                        const tbody = document.getElementById('lignes-proforma-body');
                        if (!tbody) return;

                        const tr = document.createElement('tr');
                        tr.id = 'ligne-pf-' + index;
                        tr.className = 'ligne-proforma-row';

                        const designation = (ligne.article?.designation || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                        const code = (ligne.article?.code || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                        const quantite = parseFloat(ligne.quantite) || 0;
                        const prixUnitaire = parseFloat(ligne.prixUnitaireHt || ligne.prixEstimeHt) || 0;
                        const remisePourcent = parseFloat(ligne.remisePourcent || 0) || 0;

                        tr.innerHTML =
                            '<td>' +
                            '<input type="hidden" class="ligne-article-id" value="' + (ligne.article?.id || '') + '" />' +
                            '<span class="ligne-article-code">' + code + '</span><br/>' +
                            '<span class="ligne-article-designation">' + designation + '</span>' +
                            '</td>' +
                            '<td>' +
                            '<input type="number" class="ligne-quantite" min="0.01" step="0.01" ' +
                            'value="' + quantite.toFixed(2) + '" />' +
                            '</td>' +
                            '<td>' +
                            '<input type="number" class="ligne-prix-unitaire" min="0" step="0.01" ' +
                            'value="' + prixUnitaire.toFixed(2) + '" />' +
                            '</td>' +
                            '<td>' +
                            '<input type="number" class="ligne-remise-pourcent" min="0" step="0.01" ' +
                            'value="' + remisePourcent.toFixed(2) + '" />' +
                            '</td>' +
                            '<td>' +
                            '<span id="total-pf-' + index + '" class="ligne-total-pf">0.00 ‚Ç¨</span>' +
                            '</td>' +
                            '<td>' +
                            '<button type="button" class="btn btn-danger btn-sm" data-ligne="' + index + '">üóëÔ∏è</button>' +
                            '</td>';

                        tbody.appendChild(tr);

                        const inputQuantite = tr.querySelector('.ligne-quantite');
                        const inputPrix = tr.querySelector('.ligne-prix-unitaire');
                        const inputRemise = tr.querySelector('.ligne-remise-pourcent');
                        const btnSupprimer = tr.querySelector('.btn-danger');

                        function calculerTotalLigne() {
                            const q = parseFloat(inputQuantite.value) || 0;
                            const p = parseFloat(inputPrix.value) || 0;
                            const r = parseFloat(inputRemise.value) || 0;
                            let total = q * p;
                            // Appliquer la remise
                            if (r > 0) {
                                total = total * (1 - r / 100);
                            }
                            const totalSpan = document.getElementById('total-pf-' + index);
                            if (totalSpan) {
                                totalSpan.textContent = total.toFixed(2) + ' ‚Ç¨';
                            }
                            calculerTotalGeneral();
                        }

                        if (inputQuantite) {
                            inputQuantite.addEventListener('change', calculerTotalLigne);
                            inputQuantite.addEventListener('input', calculerTotalLigne);
                        }

                        if (inputPrix) {
                            inputPrix.addEventListener('change', calculerTotalLigne);
                            inputPrix.addEventListener('input', calculerTotalLigne);
                        }

                        if (inputRemise) {
                            inputRemise.addEventListener('change', calculerTotalLigne);
                            inputRemise.addEventListener('input', calculerTotalLigne);
                        }

                        if (btnSupprimer) {
                            btnSupprimer.addEventListener('click', function () {
                                supprimerLigneProforma(index);
                            });
                        }

                        calculerTotalLigne();
                    }

                    function supprimerLigneProforma(index) {
                        const ligne = document.getElementById('ligne-pf-' + index);
                        if (ligne) {
                            ligne.remove();
                            calculerTotalGeneral();
                        }
                    }

                    function calculerTotalGeneral() {
                        let total = 0;
                        document.querySelectorAll('.ligne-total-pf').forEach(function (el) {
                            const value = parseFloat(el.textContent.replace(' ‚Ç¨', '').replace(',', '.'));
                            if (!isNaN(value)) {
                                total += value;
                            }
                        });

                        const totalLigneHtEl = document.getElementById('total-ligne-ht');
                        if (totalLigneHtEl) {
                            totalLigneHtEl.textContent = total.toFixed(2) + ' ‚Ç¨';
                        }

                        // Mettre √† jour le montant total du formulaire
                        if (montantHtInput) {
                            montantHtInput.value = total.toFixed(2);
                            calculateTotals();
                        }
                    }

                    // Fonction globale pour sauvegarder les lignes modifi√©es
                    window.sauvegarderLignes = function(event) {
                        const lignesData = [];
                        const rows = document.querySelectorAll('.ligne-proforma-row');

                        rows.forEach(function(row) {
                            const quantite = parseFloat(row.querySelector('.ligne-quantite').value) || 0;
                            const prix = parseFloat(row.querySelector('.ligne-prix-unitaire').value) || 0;
                            const remise = parseFloat(row.querySelector('.ligne-remise-pourcent').value) || 0;
                            const articleId = row.querySelector('.ligne-article-id').value;

                            lignesData.push({
                                articleId: articleId,
                                quantite: quantite,
                                prixUnitaireHt: prix,
                                remisePourcent: remise
                            });
                        });

                        // Stocker les lignes modifi√©es dans le champ hidden
                        document.getElementById('lignes-modifiees').value = JSON.stringify(lignesData);
                        console.log('üì¶ Lignes √† sauvegarder:', lignesData);
                    };
                });
            })();
        </script>
    </main>
</body>

</html>