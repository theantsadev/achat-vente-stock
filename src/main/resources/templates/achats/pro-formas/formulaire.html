<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::main})}">
<head>
    <title>Formulaire Pro-forma</title>
</head>
<body>
<main>
    <div class="container">
        <h1>ðŸ“‹ Pro-forma</h1>
        
        <div th:if="${proforma?.id}">
            <h2>Modification Pro-forma <span th:text="${proforma.numero}">PF001</span></h2>
        </div>
        <div th:unless="${proforma?.id}">
            <h2>Nouvelle Pro-forma depuis DA</h2>
        </div>
        
        <div class="card">
            <h3>Demande d'Achat</h3>
            <dl>
                <dt>NÂ° DA:</dt>
                <dd th:text="${demandeAchat?.numero}">DA001</dd>
                
                <dt>Service:</dt>
                <dd th:text="${demandeAchat?.service?.nom}">-</dd>
                
                <dt>Montant estimÃ© HT:</dt>
                <dd th:text="${#numbers.formatDecimal(demandeAchat?.montantEstimeHt, 1, 'COMMA', 2)}">-</dd>
                
                <dt>Date besoin:</dt>
                <dd th:text="${#calendars.format(demandeAchat?.dateBesoin, 'dd/MM/yyyy')}">-</dd>
            </dl>
        </div>
        
        <form th:action="${proforma?.id} ? @{/achats/pro-formas/{id}(id=${proforma.id})} : @{/achats/pro-formas}" 
              th:method="${proforma?.id} ? 'post' : 'post'">
            
            <input type="hidden" name="demandeAchat" th:value="${demandeAchat?.id}" />
            
            <div class="form-group">
                <label>Fournisseur:</label>
                <select name="fournisseur" required>
                    <option value="">-- SÃ©lectionner --</option>
                    <option th:each="f : ${fournisseurs}" 
                            th:value="${f.id}"
                            th:text="${f.raisonSociale}"
                            th:selected="${proforma?.fournisseur?.id == f.id}">
                        Fournisseur
                    </option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Montant Total HT:</label>
                <input type="number" name="montantTotalHt" step="0.01" 
                       th:value="${proforma?.montantTotalHt ?: demandeAchat?.montantEstimeHt}"
                       required />
            </div>
            
            <div class="form-group">
                <label>Montant TVA (20%):</label>
                <input type="number" name="montantTva" step="0.01" 
                       th:value="${proforma?.montantTva}"
                       readonly />
            </div>
            
            <div class="form-group">
                <label>Montant Total TTC:</label>
                <input type="number" name="montantTotalTtc" step="0.01" 
                       th:value="${proforma?.montantTotalTtc}"
                       readonly />
            </div>
            
            <div class="form-group">
                <label>DÃ©lai de livraison (jours):</label>
                <input type="number" name="delaiLivraisonJours" 
                       th:value="${proforma?.delaiLivraisonJours ?: 10}"
                       required />
            </div>
            
            <div class="form-group">
                <label>Date de validitÃ©:</label>
                <input type="date" name="dateValidite" 
                       th:value="${proforma?.dateValidite}"
                       required />
            </div>
            
            <div class="form-group">
                <label>Conditions commerciales:</label>
                <textarea name="conditionsCommerciales" rows="4" placeholder="Saisir les conditions..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Remarques:</label>
                <textarea name="remarques" rows="3" placeholder="Notes supplÃ©mentaires..."></textarea>
            </div>
            
            <div class="actions">
                <button type="submit" class="btn btn-primary">ðŸ’¾ Enregistrer</button>
                <a th:href="${proforma?.id} ? @{/achats/pro-formas/{id}(id=${proforma.id})} : @{/achats/pro-formas}" 
                   class="btn">Annuler</a>
            </div>
        </form>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const montantHtInput = document.querySelector('input[name="montantTotalHt"]');
    const montantTvaInput = document.querySelector('input[name="montantTva"]');
    const montantTtcInput = document.querySelector('input[name="montantTotalTtc"]');
    
    function calculateTotals() {
        const ht = parseFloat(montantHtInput.value) || 0;
        const tva = ht * 0.20;
        const ttc = ht + tva;
        
        montantTvaInput.value = tva.toFixed(2);
        montantTtcInput.value = ttc.toFixed(2);
    }
    
    montantHtInput.addEventListener('change', calculateTotals);
    calculateTotals();
});
</script>
</body>
</html>
