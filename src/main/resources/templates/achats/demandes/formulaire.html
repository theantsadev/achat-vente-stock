<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::main})}">

<head>
    <title>Formulaire Demande d'Achat</title>
</head>

<body>
    <main>
        <div class="container">
            <h1 th:text="${demande.id == null ? 'Nouvelle Demande d''Achat' : 'Modifier Demande d''Achat'}">
                Nouvelle Demande d'Achat
            </h1>

            <form th:action="${demande.id == null ? '/achats/demandes' : '/achats/demandes/' + demande.id}"
                th:object="${demande}" method="post">

                <div class="form-group">
                    <label>Service:</label>
                    <select th:field="*{service}" required>
                        <option value="">-- S√©lectionner --</option>
                        <option th:each="service : ${services}" th:value="${service.id}" th:text="${service.libelle}">
                            Service
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Date Besoin:</label>
                    <input type="date" th:field="*{dateBesoin}" required />
                </div>

                <div class="form-group">
                    <label>Justification:</label>
                    <textarea th:field="*{justification}" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label>Urgence:</label>
                    <select th:field="*{urgence}">
                        <option value="NORMALE">Normale</option>
                        <option value="URGENTE">Urgente</option>
                        <option value="CRITIQUE">Critique</option>
                    </select>
                </div>

                <!-- Articles √† commander -->
                <div class="form-group">
                    <h3>Articles √† commander</h3>
                    <button type="button" class="btn btn-secondary" id="btn-ajouter-ligne">
                        ‚ûï Ajouter un article
                    </button>

                    <table id="lignes-table" style="margin-top: 1rem; width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Article</th>
                                <th style="width: 15%;">Quantit√©</th>
                                <th style="width: 20%;">Prix estim√© HT</th>
                                <th style="width: 20%;">Total HT</th>
                                <th style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="lignes-body">
                            <!-- Les lignes seront ajout√©es ici dynamiquement -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold;">Total estim√© HT:</td>
                                <td id="total-ht" style="font-weight: bold;">0.00 ‚Ç¨</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="actions">
                    <button type="submit" class="btn btn-primary">üíæ Enregistrer</button>
                    <a th:href="@{/achats/demandes}" class="btn">Annuler</a>
                </div>
            </form>
        </div>

        <!-- Donn√©es articles stock√©es dans un attribut data (√©vite les probl√®mes Thymeleaf inline) -->
        <div id="articles-data" style="display:none;" th:attr="data-articles=${articlesJson}"></div>

        <script>
            (function () {
                'use strict';

                let ligneCounter = 0;
                let articlesData = [];

                // Initialisation au chargement du DOM
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('üîÑ Initialisation du formulaire DA');

                    // R√©cup√©rer les donn√©es articles depuis l'attribut data
                    const dataDiv = document.getElementById('articles-data');
                    if (dataDiv) {
                        const jsonString = dataDiv.getAttribute('data-articles');
                        if (jsonString) {
                            try {
                                articlesData = JSON.parse(jsonString);
                                console.log('‚úÖ Articles charg√©s:', articlesData.length);
                            } catch (e) {
                                console.error('‚ùå Erreur parsing JSON articles:', e);
                                articlesData = [];
                            }
                        } else {
                            console.warn('‚ö†Ô∏è Aucune donn√©e articles trouv√©e');
                        }
                    } else {
                        console.error('‚ùå √âl√©ment articles-data non trouv√©');
                    }

                    // Ajouter l'event listener au bouton
                    const btnAjouter = document.getElementById('btn-ajouter-ligne');
                    if (btnAjouter) {
                        btnAjouter.addEventListener('click', ajouterLigne);
                        console.log('‚úÖ Event listener ajout√© au bouton');
                    } else {
                        console.error('‚ùå Bouton ajouter non trouv√©');
                    }

                    // Ajouter une ligne par d√©faut si le tableau est vide
                    const tbody = document.getElementById('lignes-body');
                    if (tbody && tbody.children.length === 0) {
                        ajouterLigne();
                        console.log('‚úÖ Ligne par d√©faut ajout√©e');
                    }
                });

                function ajouterLigne() {
                    console.log('‚ûï Ajout d\'une ligne article');

                    const tbody = document.getElementById('lignes-body');
                    if (!tbody) {
                        console.error('‚ùå Tbody non trouv√©');
                        return;
                    }

                    const tr = document.createElement('tr');
                    tr.id = 'ligne-' + ligneCounter;
                    tr.className = 'ligne-article-row';

                    // Construire les options du select
                    let optionsHtml = '<option value="">-- S√©lectionner un article --</option>';
                    articlesData.forEach(function (article) {
                        const designation = (article.designation || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                        const code = (article.code || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                        const prixMoyen = article.prixAchatMoyen || 0;

                        optionsHtml += '<option value="' + article.id + '" ' +
                            'data-code="' + code + '" ' +
                            'data-designation="' + designation + '" ' +
                            'data-prix="' + prixMoyen + '">' +
                            code + ' - ' + designation +
                            '</option>';
                    });

                    const currentIndex = ligneCounter;

                    // Construire le HTML de la ligne
                    tr.innerHTML =
                        '<td>' +
                        '<select name="articleIds" class="ligne-article" required>' +
                        optionsHtml +
                        '</select>' +
                        '</td>' +
                        '<td>' +
                        '<input type="number" name="quantites" class="ligne-quantite" ' +
                        'min="1" step="1" value="1" required />' +
                        '</td>' +
                        '<td>' +
                        '<input type="number" name="prix" class="ligne-prix" ' +
                        'min="0" step="0.01" value="0.00" required />' +
                        '</td>' +
                        '<td>' +
                        '<span id="total-' + currentIndex + '" class="ligne-total">0.00 ‚Ç¨</span>' +
                        '</td>' +
                        '<td>' +
                        '<button type="button" class="btn btn-danger btn-sm" ' +
                        'data-ligne="' + currentIndex + '">üóëÔ∏è</button>' +
                        '</td>';

                    tbody.appendChild(tr);

                    // Ajouter les event listeners pour cette ligne
                    const selectArticle = tr.querySelector('.ligne-article');
                    const inputQuantite = tr.querySelector('.ligne-quantite');
                    const inputPrix = tr.querySelector('.ligne-prix');
                    const btnSupprimer = tr.querySelector('.btn-danger');

                    if (selectArticle) {
                        selectArticle.addEventListener('change', function () {
                            const selectedOption = this.options[this.selectedIndex];
                            const prix = parseFloat(selectedOption.getAttribute('data-prix')) || 0;
                            if (prix > 0 && inputPrix) {
                                inputPrix.value = prix.toFixed(2);
                                calculerTotal(currentIndex);
                            }
                        });
                    }

                    if (inputQuantite) {
                        inputQuantite.addEventListener('change', function () {
                            calculerTotal(currentIndex);
                        });
                        inputQuantite.addEventListener('input', function () {
                            calculerTotal(currentIndex);
                        });
                    }

                    if (inputPrix) {
                        inputPrix.addEventListener('change', function () {
                            calculerTotal(currentIndex);
                        });
                        inputPrix.addEventListener('input', function () {
                            calculerTotal(currentIndex);
                        });
                    }

                    if (btnSupprimer) {
                        btnSupprimer.addEventListener('click', function () {
                            supprimerLigne(currentIndex);
                        });
                    }

                    ligneCounter++;
                    console.log('‚úÖ Ligne ' + currentIndex + ' ajout√©e');
                }

                function supprimerLigne(index) {
                    console.log('üóëÔ∏è Suppression ligne ' + index);
                    const ligne = document.getElementById('ligne-' + index);
                    if (ligne) {
                        ligne.remove();
                        calculerTotalGeneral();
                        console.log('‚úÖ Ligne ' + index + ' supprim√©e');
                    }
                }

                function calculerTotal(index) {
                    const ligne = document.getElementById('ligne-' + index);
                    if (!ligne) return;

                    const inputQuantite = ligne.querySelector('.ligne-quantite');
                    const inputPrix = ligne.querySelector('.ligne-prix');

                    const quantite = parseFloat(inputQuantite.value) || 0;
                    const prix = parseFloat(inputPrix.value) || 0;
                    const total = quantite * prix;

                    const totalSpan = document.getElementById('total-' + index);
                    if (totalSpan) {
                        totalSpan.textContent = total.toFixed(2) + ' ‚Ç¨';
                    }

                    calculerTotalGeneral();
                }

                function calculerTotalGeneral() {
                    let total = 0;
                    document.querySelectorAll('.ligne-total').forEach(function (el) {
                        const value = parseFloat(el.textContent.replace(' ‚Ç¨', '').replace(',', '.'));
                        if (!isNaN(value)) {
                            total += value;
                        }
                    });

                    const totalHtEl = document.getElementById('total-ht');
                    if (totalHtEl) {
                        totalHtEl.textContent = total.toFixed(2) + ' ‚Ç¨';
                    }
                }
            })();
        </script>
    </main>
</body>

</html>