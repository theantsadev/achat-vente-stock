<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::main})}">

<head>
    <title>D√©tail Demande d'Achat</title>
</head>

<body>
    <main>
        <div class="container">
            <h1>üìã Demande d'Achat <span th:text="${demande.numero}">DA001</span></h1>

            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
            <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

            <div class="card">
                <h2>Informations G√©n√©rales</h2>
                <dl>
                    <dt>Statut:</dt>
                    <dd>
                        <span th:class="${'badge badge-' + 
                        (demande.statut == 'BROUILLON' ? 'secondary' : 
                         demande.statut == 'EN_ATTENTE' ? 'warning' : 
                         demande.statut == 'APPROUVEE' ? 'success' : 'danger')}"
                            th:text="${demande.statut}">BROUILLON</span>
                    </dd>

                    <dt>Demandeur:</dt>
                    <dd th:text="${demande.demandeur?.nom}">Dupont</dd>

                    <dt>Service:</dt>
                    <dd th:text="${demande.service?.libelle}">Informatique</dd>

                    <dt>Date Besoin:</dt>
                    <dd th:text="${#temporals.format(demande.dateBesoin, 'dd/MM/yyyy')}">01/01/2026</dd>

                    <dt>Montant Estim√© HT:</dt>
                    <dd th:text="${#numbers.formatDecimal(demande.montantEstimeHt, 1, 2) + ' ‚Ç¨'}">1000.00 ‚Ç¨</dd>

                    <dt>Urgence:</dt>
                    <dd th:text="${demande.urgence}">NORMALE</dd>

                    <dt>Justification:</dt>
                    <dd th:text="${demande.justification}">Besoin mat√©riel informatique</dd>
                </dl>
            </div>

            <!-- TODO.YML Ligne 7: Lignes de la demande -->
            <div class="card" th:if="${lignes != null and !lignes.isEmpty()}">
                <h2>Articles Demand√©s</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Article</th>
                            <th>Quantit√©</th>
                            <th>Prix Estim√© HT</th>
                            <th>Total HT</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="ligne : ${lignes}">
                            <td th:text="${ligne.article?.designation}">Article</td>
                            <td th:text="${ligne.quantite}">10</td>
                            <td th:text="${#numbers.formatDecimal(ligne.prixEstimeHt, 1, 2) + ' ‚Ç¨'}">100.00 ‚Ç¨</td>
                            <td th:text="${#numbers.formatDecimal(ligne.quantite * ligne.prixEstimeHt, 1, 2) + ' ‚Ç¨'}">
                                1000.00 ‚Ç¨</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- TODO.YML Ligne 8-9: Workflow approbation -->
            <div class="card" th:if="${validations != null and !validations.isEmpty()}">
                <h2>Historique des Validations</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Niveau</th>
                            <th>Valideur</th>
                            <th>Date</th>
                            <th>D√©cision</th>
                            <th>Commentaire</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="validation : ${validations}">
                            <td>N<span th:text="${validation.niveau}">1</span></td>
                            <td th:text="${validation.valideur?.nom}">Dupont</td>
                            <td th:text="${#temporals.format(validation.dateValidation, 'dd/MM/yyyy HH:mm')}">01/01/2026
                                10:00</td>
                            <td>
                                <span
                                    th:class="${'badge badge-' + (validation.decision == 'APPROUVEE' ? 'success' : 'danger')}"
                                    th:text="${validation.decision}">APPROUVEE</span>
                            </td>
                            <td th:text="${validation.commentaire}">OK</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- TODO.YML Ligne 8-9: Formulaire validation (visible uniquement pour les valideurs autoris√©s) -->
            <div class="card" th:if="${demande.statut == 'EN_ATTENTE' and peutValider}">
                <h2>Valider la Demande</h2>
                <form th:action="@{/achats/demandes/{id}/valider(id=${demande.id})}" method="post">
                    <input type="hidden" name="valideurId" th:value="${utilisateurConnecte.id}" />

                    <div class="form-group">
                        <label>Valideur:</label>
                        <span th:text="${utilisateurConnecte.nom}" class="form-control-static">Valideur</span>
                    </div>

                    <div class="form-group">
                        <label>Niveau d'approbation:</label>
                        <select name="niveau" required>
                            <option value="1">N1 - Chef de service</option>
                            <option value="2">N2 - Directeur</option>
                            <option value="3">N3 - DG/DAF</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>D√©cision:</label>
                        <select name="decision" required>
                            <option value="APPROUVEE">‚úÖ Approuver</option>
                            <option value="REJETEE">‚ùå Rejeter</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Commentaire:</label>
                        <textarea name="commentaire" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Valider</button>
                </form>
            </div>

            <!-- Validation Finance : Disponibilit√© des fonds -->
            <div class="card" th:if="${demande.statut == 'EN_ATTENTE_FINANCE'}"
                sec:authorize="hasAnyAuthority('ROLE-FINANCE', 'ROLE-DAF', 'ROLE-ADMIN')">
                <h2>üí∞ Validation Finance - Disponibilit√© des Fonds</h2>
                <div class="info-box info-warning">
                    <span>‚ö†Ô∏è</span>
                    <span>Cette DA a √©t√© approuv√©e par la hi√©rarchie. Veuillez confirmer la disponibilit√© des
                        fonds.</span>
                </div>
                <p><strong>Montant estim√© :</strong> <span
                        th:text="${#numbers.formatDecimal(demande.montantEstimeHt, 1, 2) + ' ‚Ç¨'}">0 ‚Ç¨</span></p>

                <form th:action="@{/achats/demandes/{id}/valider-finance(id=${demande.id})}" method="post">
                    <div class="form-group">
                        <label>D√©cision :</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="fondsDisponibles" value="true" required>
                                ‚úÖ Fonds disponibles - Approuver
                            </label>
                            <label>
                                <input type="radio" name="fondsDisponibles" value="false">
                                ‚ùå Fonds insuffisants - Rejeter
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Commentaire :</label>
                        <textarea name="commentaire" rows="3"
                            placeholder="Pr√©cisions sur la disponibilit√© budg√©taire..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary"
                        onclick="return confirm('Confirmer cette d√©cision ?')">
                        üí∞ Valider Finance
                    </button>
                </form>
            </div>

            <!-- Actions -->
            <div class="actions">
                <a th:href="@{/achats/demandes}" class="btn">‚Üê Retour</a>

                <!-- TODO.YML Ligne 8: Soumettre pour approbation -->
                <form th:if="${demande.statut == 'BROUILLON'}"
                    th:action="@{/achats/demandes/{id}/soumettre(id=${demande.id})}" method="post"
                    style="display: inline;">
                    <button type="submit" class="btn btn-warning">üì§ Soumettre pour Approbation</button>
                </form>

                <!-- TODO.YML Ligne 10: G√©n√©rer pro-forma depuis DA approuv√©e -->
                <a th:if="${demande.statut == 'APPROUVEE'}"
                    th:href="@{/achats/pro-formas/generer/{daId}(daId=${demande.id})}" class="btn btn-info">üìã G√©n√©rer
                    Pro-forma</a>

            </div>
        </div>

        <style>
            .info-box {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1rem;
            }

            .info-box.info-warning {
                background: #fff3cd;
                color: #856404;
            }

            .radio-group {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                margin-top: 0.5rem;
            }

            .radio-group label {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
            }
        </style>
    </main>
</body>

</html>