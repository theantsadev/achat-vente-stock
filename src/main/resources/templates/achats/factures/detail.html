<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::main})}">
<head>
    <title>D√©tail Facture</title>
</head>
<body>
<main>
    <div class="container">
        <h1>üìë Facture <span th:text="${facture.numeroFacture}">FACT-001</span></h1>
        
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>
        <div th:if="${warning}" class="alert alert-warning" th:text="${warning}"></div>
        
        <div class="card">
            <h2>Informations G√©n√©rales</h2>
            <dl>
                <dt>Statut:</dt>
                <dd>
                    <span th:class="${'badge badge-' + 
                        (facture.statut == 'EN_ATTENTE' ? 'warning' : 
                         facture.statut == 'VALIDEE' ? 'success' : 
                         facture.statut == 'BLOQUEE' ? 'danger' :
                         facture.statut == 'PAYEE' ? 'info' : 'secondary')}"
                          th:text="${facture.statut}">EN_ATTENTE</span>
                </dd>
                
                <dt>Fournisseur:</dt>
                <dd th:text="${facture.fournisseur?.raisonSociale}">Fournisseur</dd>
                
                <dt>Bon de Commande:</dt>
                <dd>
                    <a th:href="@{/achats/bons-commande/{id}(id=${facture.bonCommande?.id})}"
                       th:text="${facture.bonCommande?.numero}">BC001</a>
                </dd>
                
                <dt>Date Facture:</dt>
                <dd th:text="${#temporals.format(facture.dateFacture, 'dd/MM/yyyy')}">01/01/2026</dd>
                
                <dt>Date √âch√©ance:</dt>
                <dd th:text="${#temporals.format(facture.dateEcheance, 'dd/MM/yyyy')}">31/01/2026</dd>
                
                <dt>Montant HT:</dt>
                <dd th:text="${#numbers.formatDecimal(facture.montantHt, 1, 2) + ' ‚Ç¨'}">1000.00 ‚Ç¨</dd>
                
                <dt>Montant TTC:</dt>
                <dd th:text="${#numbers.formatDecimal(facture.montantTtc, 1, 2) + ' ‚Ç¨'}">1200.00 ‚Ç¨</dd>
            </dl>
        </div>
        
        <!-- TODO.YML Ligne 17: R√©sultat 3-way match -->
        <div th:class="${'card ' + (facture.threeWayMatchOk ? '' : 'alert-danger')}">
            <h2>üîç Rapprochement 3-Way Match (Facture vs R√©ception vs BC)</h2>
            <dl>
                <dt>Statut:</dt>
                <dd>
                    <span th:class="${'badge badge-' + (facture.threeWayMatchOk ? 'success' : 'danger')}"
                          th:text="${facture.threeWayMatchOk ? '‚úÖ Rapprochement OK' : '‚ùå √âcarts D√©tect√©s'}">‚ùå √âcarts D√©tect√©s</span>
                </dd>
                
                <dt th:if="${facture.ecartsThreeWay != null}">D√©tail des √©carts:</dt>
                <dd th:if="${facture.ecartsThreeWay != null}" class="text-danger" th:text="${facture.ecartsThreeWay}">
                    √âcart montant: BC=1200.00 vs Facture=1250.00
                </dd>
            </dl>
            
            <form th:action="@{/achats/factures/{id}/three-way-match(id=${facture.id})}" method="post">
                <button type="submit" class="btn btn-secondary">üîÑ Relancer 3-Way Match</button>
            </form>
        </div>
        
        <!-- TODO.YML Ligne 58: Validation (s√©paration des t√¢ches) -->
        <div class="card" th:if="${facture.statut == 'EN_ATTENTE' and facture.threeWayMatchOk}">
            <h2>Valider la Facture</h2>
            <p class="info">‚ö†Ô∏è Le valideur ne doit pas √™tre le r√©ceptionnaire (s√©paration des t√¢ches)</p>
            <form th:action="@{/achats/factures/{id}/valider(id=${facture.id})}" method="post">
                <div class="form-group">
                    <label>Valideur:</label>
                    <select name="valideurId" required>
                        <option th:each="user : ${utilisateurs}" 
                                th:value="${user.id}" 
                                th:text="${user.nom}">Utilisateur</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-success">‚úÖ Valider Facture</button>
            </form>
        </div>
        
        <!-- TODO.YML Ligne 18: D√©bloquer facture -->
        <div class="card alert-danger" th:if="${facture.statut == 'BLOQUEE'}">
            <h2>‚ö†Ô∏è Facture Bloqu√©e</h2>
            <p>Cette facture est bloqu√©e en raison d'√©carts d√©tect√©s lors du 3-way match.</p>
            <p>Le paiement est impossible tant que les √©carts ne sont pas r√©solus ou justifi√©s.</p>
            
            <form th:action="@{/achats/factures/{id}/debloquer(id=${facture.id})}" method="post">
                <div class="form-group">
                    <label>Valideur:</label>
                    <select name="valideurId" required>
                        <option th:each="user : ${utilisateurs}" 
                                th:value="${user.id}" 
                                th:text="${user.nom}">Utilisateur</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Justification du d√©blocage:</label>
                    <textarea name="justification" rows="4" required 
                              placeholder="Expliquer pourquoi la facture peut √™tre d√©bloqu√©e malgr√© les √©carts..."></textarea>
                </div>
                
                <button type="submit" class="btn btn-warning">üîì D√©bloquer Facture</button>
            </form>
        </div>
        
        <!-- Actions -->
        <div class="actions">
            <a th:href="@{/achats/factures}" class="btn">‚Üê Retour</a>
            
            <!-- TODO.YML Ligne 19: Cr√©er paiement -->
            <a th:if="${facture.statut == 'VALIDEE'}"
               th:href="@{/achats/paiements/nouveau(factureId=${facture.id})}" 
               class="btn btn-success">üí≥ Cr√©er Paiement</a>
        </div>
    </div>
</main>
</body>
</html>
