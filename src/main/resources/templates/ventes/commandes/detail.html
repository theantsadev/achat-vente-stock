<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::main})}">

<head>
    <title>D√©tail Commande Client</title>
</head>

<body>
    <main>
        <!-- TODO.YML Lignes 22-23: Commande et r√©servation stock -->
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1>üìÑ Commande <span th:text="${commande.numero}">CMD001</span></h1>
                <a th:href="@{/ventes/commandes}" class="btn btn-secondary">‚Üê Retour √† la liste</a>
            </div>

            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
            <div th:if="${info}" class="alert alert-info" th:text="${info}"></div>
            <div th:if="${warning}" class="alert alert-warning" th:text="${warning}"></div>

            <!-- Informations g√©n√©rales -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3>üìã Informations de la commande</h3>
                        </div>
                        <div class="card-body">
                            <p><strong>Num√©ro:</strong> <span th:text="${commande.numero}">-</span></p>
                            <p><strong>Devis d'origine:</strong> 
                                <a th:if="${commande.devis != null}" 
                                   th:href="@{/ventes/devis/{id}(id=${commande.devis.id})}"
                                   th:text="${commande.devis.numero}">-</a>
                                <span th:unless="${commande.devis != null}">-</span>
                            </p>
                            <p><strong>Date commande:</strong> 
                                <span th:text="${#temporals.format(commande.dateCommande, 'dd/MM/yyyy HH:mm')}">-</span>
                            </p>
                            <p><strong>Livraison pr√©vue:</strong> 
                                <span th:text="${commande.dateLivraisonPrevue != null ? #temporals.format(commande.dateLivraisonPrevue, 'dd/MM/yyyy') : 'Non d√©finie'}">-</span>
                            </p>
                            <p><strong>Statut:</strong> 
                                <span th:if="${commande.statut == 'BROUILLON'}" class="badge badge-secondary">Brouillon</span>
                                <span th:if="${commande.statut == 'CONFIRMEE'}" class="badge badge-info">Confirm√©e</span>
                                <span th:if="${commande.statut == 'EN_PREPARATION'}" class="badge badge-warning">En pr√©paration</span>
                                <span th:if="${commande.statut == 'PRET_EXPEDITION'}" class="badge badge-primary">Pr√™t pour exp√©dition</span>
                                <span th:if="${commande.statut == 'EXPEDIEE'}" class="badge badge-info">Exp√©di√©e</span>
                                <span th:if="${commande.statut == 'LIVREE'}" class="badge badge-success">Livr√©e</span>
                                <span th:if="${commande.statut == 'ANNULEE'}" class="badge badge-danger">Annul√©e</span>
                            </p>
                            <p><strong>Stock r√©serv√©:</strong>
                                <span th:if="${commande.stockReserve}" class="badge badge-success">‚úì Oui</span>
                                <span th:unless="${commande.stockReserve}" class="badge badge-secondary">Non</span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3>üë§ Client</h3>
                        </div>
                        <div class="card-body">
                            <p><strong>Raison sociale:</strong> 
                                <span th:text="${commande.client?.raisonSociale}">-</span>
                            </p>
                            <p><strong>Adresse:</strong> 
                                <span th:text="${commande.client?.adresse}">-</span>
                            </p>
                            <p><strong>T√©l√©phone:</strong> 
                                <span th:text="${commande.client?.telephone}">-</span>
                            </p>
                            <p><strong>Email:</strong> 
                                <span th:text="${commande.client?.email}">-</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lignes de commande -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3>üì¶ Articles command√©s</h3>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>D√©signation</th>
                                <th>Quantit√© command√©e</th>
                                <th>Quantit√© pr√©par√©e</th>
                                <th>Quantit√© livr√©e</th>
                                <th>Prix unitaire HT</th>
                                <th>Remise (%)</th>
                                <th>Montant HT</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="ligne : ${commande.lignes}">
                                <td th:text="${ligne.article?.code}">-</td>
                                <td th:text="${ligne.article?.designation}">-</td>
                                <td th:text="${ligne.quantite}">0</td>
                                <td th:text="${ligne.quantitePreparee}">0</td>
                                <td th:text="${ligne.quantiteLivree}">0</td>
                                <td th:text="${#numbers.formatDecimal(ligne.prixUnitaireHt, 1, 2, 'COMMA')} + ' ‚Ç¨'">-</td>
                                <td th:text="${ligne.remisePourcent != null ? ligne.remisePourcent + '%' : '-'}">-</td>
                                <td th:text="${#numbers.formatDecimal(ligne.calculerMontantHt(), 1, 2, 'COMMA')} + ' ‚Ç¨'">-</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="7" class="text-right"><strong>Total HT:</strong></td>
                                <td><strong th:text="${#numbers.formatDecimal(commande.montantTotalHt, 1, 2, 'COMMA')} + ' ‚Ç¨'">-</strong></td>
                            </tr>
                            <tr>
                                <td colspan="7" class="text-right"><strong>TVA:</strong></td>
                                <td><strong th:text="${#numbers.formatDecimal(commande.montantTotalTva, 1, 2, 'COMMA')} + ' ‚Ç¨'">-</strong></td>
                            </tr>
                            <tr>
                                <td colspan="7" class="text-right"><strong>Total TTC:</strong></td>
                                <td><strong th:text="${#numbers.formatDecimal(commande.montantTotalTtc, 1, 2, 'COMMA')} + ' ‚Ç¨'">-</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Actions selon le statut -->
            <div class="card">
                <div class="card-header">
                    <h3>‚ö° Actions</h3>
                </div>
                <div class="card-body">
                    <!-- TODO.YML Ligne 23: R√©server le stock -->
                    <form th:if="${commande.statut == 'BROUILLON' && !commande.stockReserve}" 
                          th:action="@{/ventes/commandes/{id}/reserver-stock(id=${commande.id})}" 
                          method="post" style="display:inline;">
                        <button type="submit" class="btn btn-warning">üì¶ R√©server le stock</button>
                    </form>

                    <!-- Confirmer la commande -->
                    <form th:if="${commande.statut == 'BROUILLON'}" 
                          th:action="@{/ventes/commandes/{id}/confirmer(id=${commande.id})}" 
                          method="post" style="display:inline;">
                        <button type="submit" class="btn btn-success">‚úÖ Confirmer la commande</button>
                    </form>

                    <!-- TODO.YML Ligne 24: D√©marrer la pr√©paration (picking) -->
                    <form th:if="${commande.statut == 'CONFIRMEE'}" 
                          th:action="@{/ventes/commandes/{id}/demarrer-preparation(id=${commande.id})}" 
                          method="post" style="display:inline;">
                        <button type="submit" class="btn btn-primary">üìã D√©marrer la pr√©paration</button>
                    </form>

                    <!-- Cr√©er un bon de livraison -->
                    <a th:if="${commande.statut == 'EN_PREPARATION' || commande.statut == 'CONFIRMEE'}"
                       th:href="@{/ventes/livraisons/preparer/{id}(id=${commande.id})}" 
                       class="btn btn-info">üöö Cr√©er bon de livraison</a>

                    <!-- Annuler la commande -->
                    <form th:if="${commande.statut == 'BROUILLON' || commande.statut == 'CONFIRMEE'}" 
                          th:action="@{/ventes/commandes/{id}/annuler(id=${commande.id})}" 
                          method="post" style="display:inline;">
                        <button type="submit" class="btn btn-danger" 
                                onclick="return confirm('√ätes-vous s√ªr de vouloir annuler cette commande ?')">
                            ‚ùå Annuler
                        </button>
                    </form>

                    <!-- Imprimer -->
                    <a th:href="@{/ventes/commandes/{id}/imprimer(id=${commande.id})}" 
                       class="btn btn-secondary">üñ®Ô∏è Imprimer</a>
                </div>
            </div>
        </div>
    </main>
</body>

</html>
