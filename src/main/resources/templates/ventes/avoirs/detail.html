<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::main})}">

<head>
    <title>D√©tail Avoir Client</title>
</head>

<body>
    <main>
        <!-- TODO.YML Ligne 30: Avoirs avec double validation -->
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1>üìÑ Avoir <span th:text="${avoir.numero}">AV001</span></h1>
                <a th:href="@{/ventes/avoirs}" class="btn btn-secondary">‚Üê Retour √† la liste</a>
            </div>

            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
            <div th:if="${info}" class="alert alert-info" th:text="${info}"></div>
            <div th:if="${warning}" class="alert alert-warning" th:text="${warning}"></div>

            <!-- Informations g√©n√©rales -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3>üìã Informations de l'avoir</h3>
                        </div>
                        <div class="card-body">
                            <p><strong>Num√©ro:</strong> <span th:text="${avoir.numero}">-</span></p>
                            <p><strong>Facture d'origine:</strong> 
                                <a th:if="${avoir.factureClient != null}"
                                   th:href="@{/ventes/factures/{id}(id=${avoir.factureClient.id})}"
                                   th:text="${avoir.factureClient.numero}">-</a>
                            </p>
                            <p><strong>Date:</strong> 
                                <span th:text="${#temporals.format(avoir.dateAvoir, 'dd/MM/yyyy')}">-</span>
                            </p>
                            <p><strong>Motif:</strong>
                                <span th:if="${avoir.motif == 'RETOUR'}" class="badge badge-info">Retour marchandise</span>
                                <span th:if="${avoir.motif == 'ERREUR_PRIX'}" class="badge badge-warning">Erreur de prix</span>
                                <span th:if="${avoir.motif == 'CASSE'}" class="badge badge-danger">Marchandise cass√©e</span>
                                <span th:if="${avoir.motif == 'COMMERCIAL'}" class="badge badge-primary">Geste commercial</span>
                            </p>
                            <p><strong>Statut:</strong>
                                <span th:if="${avoir.statut == 'BROUILLON'}" class="badge badge-secondary">Brouillon</span>
                                <span th:if="${avoir.statut == 'EN_ATTENTE_VALIDATION'}" class="badge badge-warning">Attente validation</span>
                                <span th:if="${avoir.statut == 'VALIDE'}" class="badge badge-info">Valid√©</span>
                                <span th:if="${avoir.statut == 'APPLIQUE'}" class="badge badge-success">Appliqu√©</span>
                                <span th:if="${avoir.statut == 'REFUSE'}" class="badge badge-danger">Refus√©</span>
                                <span th:if="${avoir.statut == 'ANNULE'}" class="badge badge-dark">Annul√©</span>
                            </p>
                            <p th:if="${avoir.commentaire != null}">
                                <strong>Commentaire:</strong> 
                                <span th:text="${avoir.commentaire}">-</span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3>üë§ Client</h3>
                        </div>
                        <div class="card-body">
                            <p><strong>Raison sociale:</strong> 
                                <span th:text="${avoir.client?.raisonSociale}">-</span>
                            </p>
                            <p><strong>Adresse:</strong> 
                                <span th:text="${avoir.client?.adresse}">-</span>
                            </p>
                        </div>
                    </div>

                    <!-- Montants -->
                    <div class="card mb-3 bg-light">
                        <div class="card-header">
                            <h3>üí∞ Montants</h3>
                        </div>
                        <div class="card-body">
                            <p><strong>Montant HT:</strong> 
                                <span th:text="${#numbers.formatDecimal(avoir.montantHt, 1, 2, 'COMMA')} + ' ‚Ç¨'">-</span>
                            </p>
                            <p><strong>TVA:</strong> 
                                <span th:text="${#numbers.formatDecimal(avoir.montantTva, 1, 2, 'COMMA')} + ' ‚Ç¨'">-</span>
                            </p>
                            <p class="h4"><strong>Montant TTC:</strong> 
                                <span th:text="${#numbers.formatDecimal(avoir.montantTtc, 1, 2, 'COMMA')} + ' ‚Ç¨'">-</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informations de validation -->
            <div class="card mb-3" th:if="${avoir.valideBy != null || avoir.createur != null}">
                <div class="card-header">
                    <h3>‚úÖ Tra√ßabilit√©</h3>
                </div>
                <div class="card-body">
                    <p th:if="${avoir.createur != null}">
                        <strong>Cr√©√© par:</strong> 
                        <span th:text="${avoir.createur.nom + ' ' + avoir.createur.prenom}">-</span>
                    </p>
                    <p th:if="${avoir.valideBy != null}">
                        <strong>Valid√© par:</strong> 
                        <span th:text="${avoir.valideBy.nom + ' ' + avoir.valideBy.prenom}">-</span>
                    </p>
                    <p th:if="${avoir.dateValidation != null}">
                        <strong>Date validation:</strong> 
                        <span th:text="${#temporals.format(avoir.dateValidation, 'dd/MM/yyyy HH:mm')}">-</span>
                    </p>
                </div>
            </div>

            <!-- Actions selon le statut -->
            <div class="card">
                <div class="card-header">
                    <h3>‚ö° Actions</h3>
                </div>
                <div class="card-body">
                    <!-- TODO.YML Ligne 30: Valider (double validation pour montants √©lev√©s) -->
                    <form th:if="${avoir.statut == 'EN_ATTENTE_VALIDATION' || avoir.statut == 'BROUILLON'}" 
                          th:action="@{/ventes/avoirs/{id}/valider(id=${avoir.id})}" 
                          method="post" style="display:inline;">
                        <button type="submit" class="btn btn-success">‚úÖ Valider l'avoir</button>
                    </form>

                    <!-- Refuser -->
                    <form th:if="${avoir.statut == 'EN_ATTENTE_VALIDATION' || avoir.statut == 'BROUILLON'}" 
                          th:action="@{/ventes/avoirs/{id}/refuser(id=${avoir.id})}" 
                          method="post" style="display:inline;">
                        <input type="text" name="motifRefus" placeholder="Motif du refus" class="form-control-sm">
                        <button type="submit" class="btn btn-danger">‚ùå Refuser</button>
                    </form>

                    <!-- Appliquer (cr√©diter le compte client) -->
                    <form th:if="${avoir.statut == 'VALIDE'}" 
                          th:action="@{/ventes/avoirs/{id}/appliquer(id=${avoir.id})}" 
                          method="post" style="display:inline;">
                        <button type="submit" class="btn btn-primary">
                            üí≥ Appliquer (cr√©diter le client)
                        </button>
                    </form>

                    <!-- Annuler -->
                    <form th:if="${avoir.statut == 'BROUILLON' || avoir.statut == 'EN_ATTENTE_VALIDATION'}" 
                          th:action="@{/ventes/avoirs/{id}/annuler(id=${avoir.id})}" 
                          method="post" style="display:inline;">
                        <button type="submit" class="btn btn-outline-danger"
                                onclick="return confirm('√ätes-vous s√ªr de vouloir annuler cet avoir ?')">
                            üóëÔ∏è Annuler
                        </button>
                    </form>

                    <!-- Imprimer -->
                    <a th:href="@{/ventes/avoirs/{id}/imprimer(id=${avoir.id})}" 
                       class="btn btn-secondary">üñ®Ô∏è Imprimer</a>
                </div>

                <!-- Alerte validation -->
                <div class="card-footer" th:if="${avoir.statut == 'EN_ATTENTE_VALIDATION'}">
                    <div class="alert alert-warning mb-0">
                        <strong>‚ö†Ô∏è Attention:</strong> Cet avoir n√©cessite une validation car son montant 
                        d√©passe le seuil autoris√©. Une double validation peut √™tre requise.
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>

</html>
